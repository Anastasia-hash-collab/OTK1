<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<title>–ö–æ–Ω—Ç—Ä–æ–ª—å –∫–∞—á–µ—Å—Ç–≤–∞ –ò–û–† –≤ –º–æ–¥—É–ª–µ. (–í—ã–∫–ª—é—á–∏—Ç–µ VPN)</title>

<style>
  * { box-sizing: border-box; }
  body {
    margin: 0;
    font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    background: #F8FAFC;
    color: #0f172a;
  }

  /* ---------------- HEADER ---------------- */

  header {
    background: #1E3A8A;
    color: white;
    padding: 14px 22px;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  header h1 {
    margin: 0;
    font-size: 20px;
    font-weight: 600;
  }

  header small {
    opacity: 0.9;
    font-size: 13px;
  }

  .role-bar {
    display: flex;
    gap: 10px;
    align-items: center;
    font-size: 13px;
  }

  .role-select {
    padding: 6px 10px;
    border-radius: 8px;
    border: none;
    background: white;
    color: #1E3A8A;
    font-weight: 600;
  }

  .role-badge {
    background: rgba(255,255,255,0.16);
    padding: 4px 10px;
    border-radius: 6px;
    font-size: 12px;
  }

  /* ---------------- LAYOUT & TABS ---------------- */

  main {
    padding: 14px;
    max-width: 1200px;
    margin: 0 auto;
  }

  .tabs {
    display: flex;
    gap: 8px;
    margin-bottom: 12px;
    border-bottom: 1px solid #E2E8F0;
  }

  .tab-button {
    padding: 8px 14px;
    border: none;
    background: transparent;
    cursor: pointer;
    font-size: 13px;
    font-weight: 600;
    color: #64748B;
    border-radius: 8px 8px 0 0;
  }

  .tab-button.active {
    background: white;
    color: #1E3A8A;
    box-shadow: 0 -1px 0 white;
  }

  .tab-content {
    display: none;
  }

  .tab-content.tab-active {
    display: block;
  }

  .card {
    background: white;
    border-radius: 16px;
    padding: 16px;
    box-shadow: 0 4px 18px rgba(15, 23, 42, 0.08);
    border: 1px solid #E2E8F0;
  }

  .card-header-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 8px;
    margin-bottom: 8px;
  }

  .card-title {
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .card-title-icon {
    width: 22px;
    height: 22px;
    border-radius: 999px;
    background: #DBEAFE;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #1D4ED8;
    font-size: 13px;
  }

  .card h2 {
    font-size: 17px;
    margin: 0;
    color: #1e3a8a;
  }

  .controls {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
  }

  label {
    font-size: 12px;
    font-weight: 500;
    color: #475569;
    display: block;
    margin-bottom: 2px;
  }

  select {
    padding: 6px 10px;
    border-radius: 8px;
    border: 1px solid #CBD5E1;
    background: white;
    color: #1E3A8A;
    font-weight: 600;
    min-width: 80px;
  }

  .info-row {
    margin: 4px 0 8px;
    font-size: 12px;
    color: #475569;
    display: flex;
    justify-content: space-between;
    gap: 10px;
  }

  /* ---------------- PROGRESS RINGS ---------------- */

  .progress-wrap {
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .progress-ring {
    width: 46px;
    height: 46px;
  }

  .progress-ring circle {
    fill: transparent;
    stroke-width: 5;
    transform: rotate(-90deg);
    transform-origin: 50% 50%;
  }

  .progress-bg {
    stroke: #E5E7EB;
  }

  .progress-value {
    stroke: #3B82F6;
    stroke-linecap: round;
    stroke-dasharray: 0 999;
    stroke-dashoffset: 0;
  }

  .progress-label {
    font-size: 11px;
    color: #64748B;
  }

  /* ---------------- TASKS ---------------- */

  .tasks {
    max-height: 60vh;
    overflow-y: auto;
    margin-top: 10px;
    border-top: 1px solid #E2E8F0;
  }

  .task-item {
    padding: 8px 4px;
    border-bottom: 1px solid #E2E8F0;
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .task-num {
    width: 26px;
    text-align: right;
    font-size: 12px;
    color: #64748B;
  }

  .task-text {
    flex: 1;
    font-size: 13px;
    color: #0f172a;
  }

  .task-checkbox {
    display: flex;
    gap: 4px;
    align-items: center;
    color: #475569;
    font-size: 12px;
    white-space: nowrap;
  }

  .task-checkbox input {
    width: 16px;
    height: 16px;
  }

  .task-right {
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    gap: 4px;
    min-width: 140px;
  }

  .task-comment-input {
    width: 160px;
    max-width: 50vw;
    padding: 3px 6px;
    font-size: 11px;
    border-radius: 6px;
    border: 1px solid #CBD5E1;
  }

  /* ---------------- STATUS / BUTTONS ---------------- */

  .footer-status {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 10px;
    padding-top: 10px;
    border-top: 1px solid #E2E8F0;
    font-size: 13px;
    gap: 10px;
    flex-wrap: wrap;
  }

  .badge {
    padding: 6px 12px;
    border-radius: 10px;
    font-weight: 600;
    font-size: 12px;
  }

  .badge-ready {
    background: #DCFCE7;
    color: #166534;
  }

  .badge-not-ready {
    background: #FEE2E2;
    color: #B91C1C;
  }

  .badge-inprogress {
    background: #DBEAFE;
    color: #1D4ED8;
  }

  button {
    padding: 6px 12px;
    background: #3B82F6;
    color: white;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
    font-size: 12px;
  }

  button:hover {
    background: #2563EB;
  }

  button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  /* ---------------- TABLE ---------------- */

  .summary-header-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin: 12px 0 6px;
    gap: 8px;
  }

  .summary-header-left {
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .tag {
    padding: 4px 10px;
    border-radius: 999px;
    background: #DBEAFE;
    color: #1E3A8A;
    font-size: 12px;
    font-weight: 600;
  }

  .summary-table-wrapper {
    width: 100%;
    overflow-x: auto;
  }

  .summary-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 4px;
    min-width: 360px;
  }

  .summary-table th {
    background: #EFF6FF;
    font-size: 11px;
    padding: 6px 8px;
    text-transform: uppercase;
    border-bottom: 2px solid #BFDBFE;
    color: #1e3a8a;
  }

  .summary-table td {
    padding: 6px 8px;
    border-bottom: 1px solid #E2E8F0;
    font-size: 12px;
  }

  .row-ready {
    background: #ECFDF5;
  }

  .percent-cell {
    font-variant-numeric: tabular-nums;
  }

  #floorFilterSelect {
    padding: 4px 8px;
    border-radius: 8px;
    border: 1px solid #CBD5E1;
    background: white;
    color: #1E3A8A;
    font-size: 11px;
    font-weight: 500;
  }

  .percent-colored {
    font-weight: 600;
    color: white;
    padding: 4px 8px;
    border-radius: 6px;
    text-align: center;
    min-width: 55px;
    display: inline-block;
  }

  @media (max-width: 600px) {
    header {
      flex-direction: column;
      align-items: flex-start;
      gap: 8px;
    }
    .role-bar {
      align-self: flex-end;
    }
  }

  @media (max-width: 480px) {
    body {
      font-size: 14px;
    }

    header {
      padding: 10px 12px;
      flex-direction: column;
      align-items: flex-start;
      gap: 6px;
    }

    header h1 {
      font-size: 16px;
    }

    main {
      padding: 10px;
    }

    .card {
      padding: 12px;
      border-radius: 12px;
    }

    .controls {
      flex-direction: column;
      align-items: flex-start;
      gap: 8px;
    }

    .info-row {
      flex-direction: column;
      align-items: flex-start;
      gap: 2px;
    }

    .tasks {
      max-height: 55vh;
    }

    .task-item {
      align-items: flex-start;
    }

    .task-checkbox {
      font-size: 13px;
    }

    .task-checkbox input {
      width: 20px;
      height: 20px;
    }

    .tabs {
      overflow-x: auto;
    }

    .tab-button {
      white-space: nowrap;
      padding: 8px 10px;
    }

    .summary-header-row {
      flex-direction: column;
      align-items: flex-start;
      gap: 4px;
    }

    .task-right {
      align-items: stretch;
    }
    .task-comment-input {
      width: 100%;
      max-width: 100%;
    }
  }
</style>
</head>

<body>

<header>
  <div>
    <h1>–ö–æ–Ω—Ç—Ä–æ–ª—å –∫–∞—á–µ—Å—Ç–≤–∞ –ò–û–† –≤ –º–æ–¥—É–ª–µ. (–í—ã–∫–ª—é—á–∏—Ç–µ VPN)</h1>
    <small>–ß–µ—Ä—ë–º—É—à–∫–∏ ¬∑ –ö–æ—Ä–ø—É—Å 1 ¬∑ —Å–µ–∫—Ü–∏—è 1 ¬∑ –û–¢–ö</small>
  </div>
  <div class="role-bar">
    <span>–†–µ–∂–∏–º:</span>
    <select id="roleSelect" class="role-select">
      <option value="viewer">–ü—Ä–æ—Å–º–æ—Ç—Ä</option>
      <option value="otk">–û–¢–ö</option>
      <option value="chief">–†—É–∫. –û–¢–ö</option>
    </select>
    <span id="roleBadge" class="role-badge">–¢–æ–ª—å–∫–æ –ø—Ä–æ—Å–º–æ—Ç—Ä</span>
  </div>
</header>

<main>
  <div class="tabs">
    <button class="tab-button active" data-tab="module">–ß–µ–∫-–ª–∏—Å—Ç</button>
    <button class="tab-button" data-tab="section">–°–≤–æ–¥–Ω–∞—è –ø–æ —Å–µ–∫—Ü–∏–∏</button>
  </div>

  <!-- TAB: MODULE -->
  <div class="tab-content tab-active" id="tab-module">
    <section class="card">
      <div class="card-header-row">
        <div class="card-title">
          <div class="card-title-icon">üèó</div>
          <h2>–†–∞–±–æ—Ç—ã –ø–æ –º–æ–¥—É–ª—é</h2>
        </div>
        <div class="controls">
          <div>
            <label>–ú–æ–¥—É–ª—å</label>
            <select id="moduleSelect"></select>
          </div>
          <div>
            <label>–ì—Ä—É–ø–ø–∞</label>
            <select id="groupSelect"></select>
          </div>
        </div>
      </div>

      <div class="info-row">
        <span id="moduleTypeHint">–¢–∏–ø–æ–≤–æ–π –º–æ–¥—É–ª—å</span>
        <span id="moduleFloorInfo">–≠—Ç–∞–∂: 2</span>
      </div>

      <div id="tasksContainer" class="tasks"></div>

      <div class="footer-status">
        <div class="progress-wrap">
          <svg class="progress-ring" viewBox="0 0 40 40">
            <circle class="progress-bg" cx="20" cy="20" r="16"></circle>
            <circle id="moduleProgressCircle" class="progress-value" cx="20" cy="20" r="16"></circle>
          </svg>
          <div>
            <div id="percentQA">–ü—Ä–∏–Ω—è—Ç–æ –û–¢–ö: 0%</div>
            <div class="progress-label">–¢–µ–∫—É—â–∏–π –º–æ–¥—É–ª—å</div>
          </div>
        </div>
        <span id="statusBadge" class="badge badge-not-ready">–ù–µ –Ω–∞—á–∞—Ç–æ</span>
        <div style="display:flex; gap:6px; flex-wrap:wrap;">
          <button id="exportModuleCsv">–≠–∫—Å–ø–æ—Ä—Ç —á–µ–∫-–ª–∏—Å—Ç–∞</button>
          <button id="resetModule">–°–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ</button>
        </div>
      </div>
    </section>
  </div>

  <!-- TAB: SECTION -->
  <div class="tab-content" id="tab-section">
    <section class="card">
      <div class="card-header-row">
        <div class="card-title">
          <div class="card-title-icon">üìä</div>
          <h2>–°–≤–æ–¥–Ω–∞—è –ø–æ —Å–µ–∫—Ü–∏–∏</h2>
        </div>
        <div class="progress-wrap">
          <svg class="progress-ring" viewBox="0 0 40 40">
            <circle class="progress-bg" cx="20" cy="20" r="16"></circle>
            <circle id="sectionProgressCircle" class="progress-value" cx="20" cy="20" r="16"></circle>
          </svg>
          <div>
            <div id="sectionPercentQA">–ü—Ä–∏–Ω—è—Ç–æ –û–¢–ö: 0%</div>
            <div class="progress-label">–í—Å—è —Å–µ–∫—Ü–∏—è</div>
          </div>
        </div>
      </div>

      <div class="footer-status">
        <span id="sectionStatusBadge" class="badge badge-not-ready">–°–µ–∫—Ü–∏—è –Ω–µ –Ω–∞—á–∞—Ç–∞</span>
        <button id="exportCsv">–≠–∫—Å–ø–æ—Ä—Ç CSV</button>
      </div>

      <div class="summary-header-row">
        <div class="summary-header-left">
          <strong>–ú–æ–¥—É–ª–∏</strong>
          <select id="floorFilterSelect"></select>
        </div>
        <span id="summaryReadyCount" class="tag">–ì–æ—Ç–æ–≤–æ: 0</span>
      </div>

      <div class="summary-table-wrapper">
        <table class="summary-table">
          <thead>
          <tr>
            <th>–ú–æ–¥—É–ª—å</th>
            <th>–≠—Ç–∞–∂</th>
            <th>%</th>
            <th>–°—Ç–∞—Ç—É—Å</th>
          </tr>
          </thead>
          <tbody id="summaryTableBody"></tbody>
        </table>
      </div>
    </section>
  </div>
</main>

<!-- ---------------- FIREBASE ---------------- -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyBwWguFZ48BuuYpIG8nEX1zHAIx3BOXFsI",
    authDomain: "qc-modules.firebaseapp.com",
    projectId: "qc-modules",
    storageBucket: "qc-modules.firebasestorage.app",
    messagingSenderId: "430400564818",
    appId: "1:430400564818:web:2e46915026cedd4323798b",
    measurementId: "G-LHCERM1GLW"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  const docRef = db.collection("qc_modules").doc("section1");
</script>

<!-- ---------------- APP LOGIC ---------------- -->
<script>
  const TOTAL_MODULES = 176;

  const ROLE_PASSWORDS = {
    otk: "otk123",   // –æ–±—ã—á–Ω—ã–π –∏–Ω—Å–ø–µ–∫—Ç–æ—Ä –û–¢–ö
    chief: "1212"    // —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å –û–¢–ö
  };

  const ROLE_LABELS = {
    viewer: "–¢–æ–ª—å–∫–æ –ø—Ä–æ—Å–º–æ—Ç—Ä",
    otk: "–û–¢–ö: –º–æ–∂–Ω–æ —Ç–æ–ª—å–∫–æ —Å—Ç–∞–≤–∏—Ç—å –≥–∞–ª–æ—á–∫–∏",
    chief: "–†—É–∫. –û–¢–ö: –º–æ–∂–Ω–æ —Å—Ç–∞–≤–∏—Ç—å –∏ —Å–Ω–∏–º–∞—Ç—å –≥–∞–ª–æ—á–∫–∏"
  };

  const TASKS_STANDARD = [
    "–°–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–µ—Ä–µ–≥–æ—Ä–æ–¥–∫–∏ –∏–∑ –ì–ö–õ –Ω–∞ –º–µ—Ç–∞–ª–ª–∏—á–µ—Å–∫–æ–º –∫–∞—Ä–∫–∞—Å–µ –≤ –¥–≤–∞ —Å–ª–æ—è —Å –∑–∞—á–µ–∫–∞–Ω–∫–æ–π —à–≤–æ–≤ –∏ –∑–≤—É–∫–æ–∏–∑–æ–ª—è—Ü–∏–µ–π.",
    "–°–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–∞–Ω—Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π –º–æ–¥—É–ª—å —Å –∑–∞–ª–∏—Ç—ã–º —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–º —à–≤–æ–º –ø–æ –∫–æ–Ω—Ç—É—Ä—É.",
    "–ó–∞–≤–µ—Ä—à—ë–Ω–Ω–∞—è –≤–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –æ—Ç–¥–µ–ª–∫–∞ —Å–∞–Ω—Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–≥–æ –º–æ–¥—É–ª—è —Å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–º —Å–∞–Ω—Ñ–∞—è–Ω—Å–æ–º –∏ —Å–º–µ—Å–∏—Ç–µ–ª—è–º–∏.",
    "–ü–æ—Ç–æ–ª–æ–∫ –∏–∑ –º–µ—Ç–∞–ª–ª–∏—á–µ—Å–∫–æ–≥–æ –ø—Ä–æ—Ñ–∏–ª—è, –∑–∞—à–∏—Ç—ã–π —Ü–µ–º–µ–Ω—Ç–Ω–æ-–ø–µ—Ä–ª–∏—Ç–æ–≤—ã–º–∏ –ø–ª–∏—Ç–∞–º–∏ —Å –ø—Ä–æ–∫–ª–µ–π–∫–æ–π —Å—Ç—ã–∫–æ–≤ –ª–µ–Ω—Ç–æ–π –ì–µ—Ä–ª–µ–Ω. –ö—Ä–µ–ø–ª–µ–Ω–∏–µ –ø–æ—Ç–æ–ª–∫–∞ –Ω–∞ –∞–Ω–∫–µ—Ä–∞—Ö.",
    "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–∏—Ç–µ–ª—å–Ω—ã—Ö –∫–æ—Ä–æ–±–æ–∫, –ø–æ–¥—Ä–æ–∑–µ—Ç–Ω–∏–∫–æ–≤ –∏ –ø—Ä–æ–∫–ª–∞–¥–∫–∞ –∫–∞–±–µ–ª—è —Å —Ä–∞—Å–∫–ª—é—á–µ–Ω–∏–µ–º.",
    "–ú–æ–Ω—Ç–∞–∂ –∫–≤–∞—Ä—Ç–∏—Ä–Ω—ã—Ö —ç–ª–µ–∫—Ç—Ä–∏—á–µ—Å–∫–∏—Ö —â–∏—Ç–∫–æ–≤.",
    "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –≥–∏–ª—å–∑-–ø–∞–∫–µ—Ç–æ–≤ –≠–û–ú –≤ –º–µ—Å—Ç–∞—Ö –æ–±—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è (–ú–û–ü).",
    "–í—ã–ø–æ–ª–Ω–µ–Ω–Ω–∞—è –≤–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –∫–≤–∞—Ä—Ç–∏—Ä–Ω–∞—è —Ä–∞–∑–≤–æ–¥–∫–∞ –≤–µ–Ω—Ç–∏–ª—è—Ü–∏–∏.",
    "–ú–æ–Ω—Ç–∞–∂ –¥—ã–º–æ—É–¥–∞–ª–µ–Ω–∏—è –∏ –¥—ã–º–æ–ø—Ä–∏—ë–º–Ω–∏–∫–æ–≤.",
    "–ú–æ–Ω—Ç–∞–∂ –≤–µ–Ω—Ç–∏–ª—è—Ü–∏–æ–Ω–Ω—ã—Ö —Å–∏—Å—Ç–µ–º –≤ –ú–û–ü.",
    "–ú–æ–Ω—Ç–∞–∂ —Å–∏—Å—Ç–µ–º—ã –ø–æ–∂–∞—Ä–æ—Ç—É—à–µ–Ω–∏—è –∏ –≥–ª–∞–≤–Ω–æ–≥–æ —Å—Ç–æ—è–∫–∞.",
    "–ú–æ–Ω—Ç–∞–∂ —Å–∏—Å—Ç–µ–º—ã –≤–æ–¥–æ—Å–Ω–∞–±–∂–µ–Ω–∏—è –∏ –∫–∞–Ω–∞–ª–∏–∑–∞—Ü–∏–∏ (+ —Å—Ç–æ—è–∫ –ö1).",
    "–ú–æ–Ω—Ç–∞–∂ —Å—Ç–æ—è–∫–∞ –ö2.",
    "–ú–æ–Ω—Ç–∞–∂ —Å—Ç–æ—è–∫–æ–≤ –æ—Ç–æ–ø–ª–µ–Ω–∏—è.",
    "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ä–∞–¥–∏–∞—Ç–æ—Ä–æ–≤.",
    "–ó–∞—á–µ–∫–∞–Ω–∫–∞ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏—Ö –æ—Ç–≤–µ—Ä—Å—Ç–∏–π –∏–Ω–∂–µ–Ω–µ—Ä–Ω—ã—Ö –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–π (–≤–µ–Ω—Ç–∏–ª—è—Ü–∏—è, –ö1).",
    "–ú–æ–Ω—Ç–∞–∂ –º–µ—Ç–∞–ª–ª–∏—á–µ—Å–∫–æ–≥–æ –∫–∞—Ä–∫–∞—Å–∞ –∑–∞—à–∏–≤–∫–∏ –∏–Ω–∂–µ–Ω–µ—Ä–Ω—ã—Ö –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–π –ú–û–ü.",
    "–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –ø—Ä–æ—Ç–∏–≤–æ–ø–æ–∂–∞—Ä–Ω—ã—Ö –æ—Ç—Å–µ—á–µ–∫ –∏–Ω–∂–µ–Ω–µ—Ä–Ω—ã—Ö –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–π –ú–û–ü.",
    "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –æ–∫–æ–Ω–Ω—ã—Ö –∏ –¥–≤–µ—Ä–Ω—ã—Ö –±–ª–æ–∫–æ–≤ –∏–∑ –∞–ª—é–º–∏–Ω–∏—è –∏ –ü–í–• —Å –º–æ–Ω—Ç–∞–∂–æ–º —Å—Ç–µ–∫–ª–æ–ø–∞–∫–µ—Ç–æ–≤, —Ñ—É—Ä–Ω–∏—Ç—É—Ä—ã –∏ –≥–µ—Ä–º–µ—Ç–∏–∑–∞—Ü–∏–µ–π —à–≤–æ–≤.",
    "–ú–æ–Ω—Ç–∞–∂ –ø–æ–¥–æ–∫–æ–Ω–Ω–∏–∫–æ–≤ –∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –æ—Ç–∫–æ—Å–æ–≤.",
    "–£–∫–ª–∞–¥–∫–∞ –ø–ª–∏—Ç–∫–∏ —Ñ–∞—Ä—Ç—É–∫–∞, –∫—É—Ö–Ω–∏, –∫–æ—Ä–∏–¥–æ—Ä–∞, –ú–û–ü –∏ –±–∞–ª–∫–æ–Ω–∞ —Å –ø–æ—Å–ª–µ–¥—É—é—â–µ–π –∑–∞—Ç–∏—Ä–∫–æ–π.",
    "–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –º–æ–∫—Ä–æ–≥–æ —à—Ç—É–∫–∞—Ç—É—Ä–Ω–æ–≥–æ —Ñ–∞—Å–∞–¥–∞ –±–∞–ª–∫–æ–Ω–∞.",
    "–ú–æ–Ω—Ç–∞–∂ –∫—Ä–æ–Ω—à—Ç–µ–π–Ω–æ–≤ –∏ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–≥–æ –ø—Ä–æ—Ñ–∏–ª—è –ø–æ–¥—Å–∏—Å—Ç–µ–º—ã –ù–í–§.",
    "–ú–æ–Ω—Ç–∞–∂ —É—Ç–µ–ø–ª–∏—Ç–µ–ª—è –ø–æ —Ñ–∞—Å–∞–¥—É –º–æ–¥—É–ª—è.",
    "–ú–æ–Ω—Ç–∞–∂ –ø—Ä–æ—Ç–∏–≤–æ–ø–æ–∂–∞—Ä–Ω–æ–π –æ—Ç—Å–µ—á–∫–∏ –°–ü–ö."
  ];

  const TASKS_LLU = [
    "–ú–æ–Ω—Ç–∞–∂ –¥–≤–µ—Ä–µ–π –õ–õ–£.",
    "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –æ–∫–æ–Ω–Ω—ã—Ö –±–ª–æ–∫–æ–≤ —Å –º–æ–Ω—Ç–∞–∂–æ–º —Å—Ç–µ–∫–ª–æ–ø–∞–∫–µ—Ç–æ–≤ –∏ –∑–∞—á–µ–∫–∞–Ω–∫–æ–π —à–≤–æ–≤.",
    "–£–∫–ª–∞–¥–∫–∞ –ø–ª–∏—Ç–∫–∏ –õ–õ–£.",
    "–ó–∞—à–∏–≤–∫–∞ —Ç–æ—Ä—Ü–æ–≤ –ª–µ—Å—Ç–Ω–∏—á–Ω—ã—Ö –º–∞—Ä—à–µ–π.",
    "–û–∫—Ä–∞—Å–∫–∞ –ø–ª–∏—Ç –ø–µ—Ä–µ—Ö–æ–¥–Ω—ã—Ö –ø–ª–æ—â–∞–¥–æ–∫.",
    "–ú–æ–Ω—Ç–∞–∂ –ª–∏—Ñ—Ç–æ–≤–æ–≥–æ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è –õ–õ–£."
  ];

  const GROUP_NAMES = ["–í—Å–µ", "–°–¢–ö", "–í–ò–°", "–≠–û–ú", "–ü–æ—Ç–æ–ª–∫–∏", "–§–∞—Å–∞–¥", "–û—Ç–¥–µ–ª–∫–∞"];
  const GROUP_INDICES = {
    "–°–¢–ö":      [2, 3],
    "–í–ò–°":      [8, 9, 10, 11, 12, 13, 14, 15],
    "–≠–û–ú":      [5, 6, 7],
    "–ü–æ—Ç–æ–ª–∫–∏":  [4],
    "–§–∞—Å–∞–¥":    [23, 24, 25],
    "–û—Ç–¥–µ–ª–∫–∞":  [1, 16, 17, 18, 19, 20, 21, 22]
  };

  const LLU_MODULES = new Set();
  (function initLluModules() {
    for (let n = 0; ; n++) {
      const num = 5 + 8 * n;
      if (num > TOTAL_MODULES) break;
      LLU_MODULES.add("M" + num);
    }
  })();

  function isLluModule(moduleId) {
    return LLU_MODULES.has(moduleId);
  }

  function getTasksForModule(moduleId) {
    return isLluModule(moduleId) ? TASKS_LLU : TASKS_STANDARD;
  }

  function getVisibleTaskIndices(moduleId) {
    if (isLluModule(moduleId)) {
      const len = TASKS_LLU.length;
      return Array.from({ length: len }, (_, i) => i);
    }
    if (currentGroup === "–í—Å–µ") {
      const len = TASKS_STANDARD.length;
      return Array.from({ length: len }, (_, i) => i);
    }
    const nums = GROUP_INDICES[currentGroup] || [];
    return nums
      .map((n) => n - 1)
      .filter((i) => i >= 0 && i < TASKS_STANDARD.length);
  }

  function getModuleNumber(moduleId) {
    return parseInt(moduleId.replace("M", ""), 10) || 1;
  }

  function getFloor(moduleId) {
    const num = getModuleNumber(moduleId);
    return 1 + Math.ceil(num / 8);
  }

  let modulesData = {};
  let currentModuleId = "M1";
  let currentRole = "viewer";
  let currentGroup = "–í—Å–µ";
  let currentFloorFilter = "all";
  const authenticatedRoles = { otk: false, chief: false };

  function ensureModuleArraysSize(moduleId) {
    const tasks = getTasksForModule(moduleId);
    const len = tasks.length;

    if (!modulesData[moduleId]) {
      modulesData[moduleId] = {
        qaTasks: Array(len).fill(false),
        comments: Array(len).fill("")
      };
      return;
    }

    const m = modulesData[moduleId];

    if (!Array.isArray(m.qaTasks)) m.qaTasks = [];
    if (!Array.isArray(m.comments)) m.comments = [];

    const newQA = Array(len).fill(false);
    const newComments = Array(len).fill("");

    const copyLen = Math.min(len, m.qaTasks.length, m.comments.length || len);

    for (let i = 0; i < copyLen; i++) {
      newQA[i] = !!m.qaTasks[i];
      newComments[i] = m.comments[i] || "";
    }

    m.qaTasks = newQA;
    m.comments = newComments;
  }

  function initModulesData() {
    for (let i = 1; i <= TOTAL_MODULES; i++) {
      const id = "M" + i;
      ensureModuleArraysSize(id);
    }
  }

  function calculatePercent(arr) {
    if (!Array.isArray(arr) || arr.length === 0) return 0;
    const total = arr.length;
    const done = arr.filter(Boolean).length;
    return Math.round((done / total) * 100);
  }

  function updateProgressCircle(circleId, percent) {
    const circle = document.getElementById(circleId);
    if (!circle) return;
    const radius = circle.r.baseVal.value;
    const circumference = 2 * Math.PI * radius;
    circle.style.strokeDasharray = `${circumference} ${circumference}`;
    const offset = circumference - (percent / 100) * circumference;
    circle.style.strokeDashoffset = offset;
  }

  function updateRoleUI() {
    const badge = document.getElementById("roleBadge");
    badge.textContent = ROLE_LABELS[currentRole] || "";

    const resetBtn = document.getElementById("resetModule");
    if (resetBtn) {
      const isChief = currentRole === "chief";
      resetBtn.disabled = !isChief;
    }

    renderTasks();
  }

  function setRole(role) {
    currentRole = role;
    document.getElementById("roleSelect").value = role;
    updateRoleUI();
  }

  function handleRoleChange(e) {
    const newRole = e.target.value;
    if (newRole === "viewer") {
      setRole("viewer");
      return;
    }

    if (authenticatedRoles[newRole]) {
      setRole(newRole);
      return;
    }

    const pwd = prompt("–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å –¥–ª—è –û–¢–ö:");
    if (pwd === ROLE_PASSWORDS[newRole]) {
      authenticatedRoles[newRole] = true;
      setRole(newRole);
    } else {
      alert("–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å");
      e.target.value = currentRole;
    }
  }

  function populateModuleSelect() {
    const select = document.getElementById("moduleSelect");
    select.innerHTML = "";
    for (let i = 1; i <= TOTAL_MODULES; i++) {
      const id = "M" + i;
      const option = document.createElement("option");
      option.value = id;
      option.textContent = id + (isLluModule(id) ? " (–õ–õ–£)" : "");
      select.appendChild(option);
    }
    select.value = currentModuleId;
  }

  function populateGroupSelect() {
    const select = document.getElementById("groupSelect");
    select.innerHTML = "";
    GROUP_NAMES.forEach((name) => {
      const opt = document.createElement("option");
      opt.value = name;
      opt.textContent = name;
      select.appendChild(opt);
    });
    select.value = currentGroup;
  }

  function populateFloorFilter() {
    const select = document.getElementById("floorFilterSelect");
    if (!select) return;
    select.innerHTML = "";

    const optAll = document.createElement("option");
    optAll.value = "all";
    optAll.textContent = "–í—Å–µ —ç—Ç–∞–∂–∏";
    select.appendChild(optAll);

    const maxFloor = getFloor("M" + TOTAL_MODULES);
    for (let floor = 2; floor <= maxFloor; floor++) {
      const opt = document.createElement("option");
      opt.value = String(floor);
      opt.textContent = floor + " —ç—Ç–∞–∂";
      select.appendChild(opt);
    }

    select.value = currentFloorFilter;
  }

  function updateModuleTypeHint() {
    const hint = document.getElementById("moduleTypeHint");
    if (isLluModule(currentModuleId)) {
      hint.textContent = "–ú–æ–¥—É–ª—å –õ–õ–£";
    } else {
      hint.textContent = "–û–±—ã—á–Ω—ã–π –º–æ–¥—É–ª—å";
    }
  }

  function updateModuleFloorInfo() {
    const el = document.getElementById("moduleFloorInfo");
    const floor = getFloor(currentModuleId);
    el.textContent = "–≠—Ç–∞–∂: " + floor;
  }

  function updateGroupUIForModule() {
    const select = document.getElementById("groupSelect");
    if (!select) return;
    if (isLluModule(currentModuleId)) {
      select.disabled = true;
    } else {
      select.disabled = false;
    }
  }

  function statusByPercent(p) {
    if (p === 0) return "–ù–µ –Ω–∞—á–∞—Ç–æ (0%)";
    if (p === 100) return "–ì–æ—Ç–æ–≤–æ –∫ –æ—Ç–≥—Ä—É–∑–∫–µ (100%)";
    return "–í —Ä–∞–±–æ—Ç–µ (1‚Äì99%)";
  }

  function badgeClassByPercent(baseClass, p) {
    if (p === 0) return baseClass + " badge-not-ready";
    if (p === 100) return baseClass + " badge-ready";
    return baseClass + " badge-inprogress";
  }

  function updateModuleStats() {
    ensureModuleArraysSize(currentModuleId);
    const moduleData = modulesData[currentModuleId];
    const qaPercent = calculatePercent(moduleData.qaTasks);

    document.getElementById("percentQA").textContent =
      "–ü—Ä–∏–Ω—è—Ç–æ –û–¢–ö: " + qaPercent + "%";

    const badgeEl = document.getElementById("statusBadge");
    badgeEl.textContent = statusByPercent(qaPercent);
    badgeEl.className = badgeClassByPercent("badge", qaPercent);

    updateProgressCircle("moduleProgressCircle", qaPercent);
  }

  function updateSummaryTable() {
    const tbody = document.getElementById("summaryTableBody");
    tbody.innerHTML = "";

    let readyCountAll = 0;
    let sumQAAll = 0;

    for (let i = 1; i <= TOTAL_MODULES; i++) {
      const id = "M" + i;
      ensureModuleArraysSize(id);
      const data = modulesData[id];
      const qaPercent = calculatePercent(data.qaTasks);
      const ready = qaPercent === 100;
      const floor = getFloor(id);

      sumQAAll += qaPercent;
      if (ready) readyCountAll++;

      if (currentFloorFilter !== "all" && floor !== Number(currentFloorFilter)) {
        continue;
      }

      const tr = document.createElement("tr");
      if (ready) tr.classList.add("row-ready");

      const tdModule = document.createElement("td");
      tdModule.textContent = id + (isLluModule(id) ? " (–õ–õ–£)" : "");

      const tdFloor = document.createElement("td");
      tdFloor.textContent = floor;

      const tdQA = document.createElement("td");
      tdQA.className = "percent-cell";

      const colorSpan = document.createElement("span");
      colorSpan.className = "percent-colored";
      colorSpan.textContent = qaPercent + "%";
      colorSpan.style.backgroundColor = getColorForPercent(qaPercent);

      tdQA.appendChild(colorSpan);

      const tdStatus = document.createElement("td");
      tdStatus.textContent = statusByPercent(qaPercent);

      tr.appendChild(tdModule);
      tr.appendChild(tdFloor);
      tr.appendChild(tdQA);
      tr.appendChild(tdStatus);
      tbody.appendChild(tr);
    }

    const sectionQA = Math.round(sumQAAll / TOTAL_MODULES);

    document.getElementById("sectionPercentQA").textContent =
      "–ü—Ä–∏–Ω—è—Ç–æ –û–¢–ö: " + sectionQA + "%";

    const sectionStatusBadge = document.getElementById("sectionStatusBadge");
    let sectionText;
    if (sectionQA === 0) sectionText = "–°–µ–∫—Ü–∏—è –Ω–µ –Ω–∞—á–∞—Ç–∞";
    else if (sectionQA === 100) sectionText = "–°–µ–∫—Ü–∏—è –≥–æ—Ç–æ–≤–∞ –∫ –æ—Ç–≥—Ä—É–∑–∫–µ";
    else sectionText = "–°–µ–∫—Ü–∏—è –≤ —Ä–∞–±–æ—Ç–µ";

    sectionStatusBadge.textContent = sectionText;
    sectionStatusBadge.className = badgeClassByPercent("badge", sectionQA);

    document.getElementById("summaryReadyCount").textContent =
      "–ì–æ—Ç–æ–≤–æ: " + readyCountAll;

    updateProgressCircle("sectionProgressCircle", sectionQA);
  }

  function resetCurrentModule() {
    const tasks = getTasksForModule(currentModuleId);
    const len = tasks.length;
    modulesData[currentModuleId].qaTasks = Array(len).fill(false);
    modulesData[currentModuleId].comments = Array(len).fill("");
    renderTasks();
    updateSummaryTable();
    saveToFirestore();
  }

  function exportSummaryToCsv() {
    let rows = [];
    rows.push(["–ú–æ–¥—É–ª—å", "–≠—Ç–∞–∂", "% –û–¢–ö", "–°—Ç–∞—Ç—É—Å"]);

    for (let i = 1; i <= TOTAL_MODULES; i++) {
      const id = "M" + i;
      ensureModuleArraysSize(id);
      const data = modulesData[id];
      const qaPercent = calculatePercent(data.qaTasks);
      const floor = getFloor(id);
      const status = statusByPercent(qaPercent);

      rows.push([id, String(floor), String(qaPercent) + "%", status]);
    }

    const csvContent = rows
      .map((row) =>
        row.map((field) => `"${String(field).replace(/"/g, '""')}"`).join(";")
      )
      .join("\r\n");

    const blob = new Blob(
      ["\uFEFF" + csvContent],
      { type: "text/csv;charset=utf-8;" }
    );
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "svodka_cheryomushki.csv";
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }

  function exportModuleChecklistToCsv() {
    const moduleId = currentModuleId;
    const floor = getFloor(moduleId);
    ensureModuleArraysSize(moduleId);

    const tasks = getTasksForModule(moduleId);
    const moduleData = modulesData[moduleId];

    let rows = [];
    rows.push(["–ú–æ–¥—É–ª—å", "–≠—Ç–∞–∂", "‚Ññ", "–í–∏–¥ —Ä–∞–±–æ—Ç", "–ü—Ä–∏–Ω—è—Ç–æ –û–¢–ö"]);

    tasks.forEach((taskText, index) => {
      const accepted = moduleData.qaTasks[index] ? "–î–∞" : "–ù–µ—Ç";
      rows.push([
        moduleId,
        String(floor),
        String(index + 1),
        taskText,
        accepted
      ]);
    });

    const csvContent = rows
      .map(row =>
        row
          .map(field => `"${String(field).replace(/"/g, '""')}"`)
          .join(";")
      )
      .join("\r\n");

    const blob = new Blob(
      ["\uFEFF" + csvContent],
      { type: "text/csv;charset=utf-8;" }
    );
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `checklist_${moduleId}.csv`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }

  async function loadFromFirestore() {
    try {
      const snap = await docRef.get();
      if (snap.exists) {
        const data = snap.data();
        if (data && data.modulesData && typeof data.modulesData === "object") {
          modulesData = data.modulesData;
        }
      }
    } catch (e) {
      console.warn("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑ Firestore:", e);
    }
    initModulesData();
  }

  async function saveToFirestore() {
    try {
      await docRef.set({ modulesData }, { merge: true });
    } catch (e) {
      console.warn("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ Firestore:", e);
    }
  }

  function renderTasks() {
    ensureModuleArraysSize(currentModuleId);

    const container = document.getElementById("tasksContainer");
    container.innerHTML = "";

    updateModuleTypeHint();
    updateModuleFloorInfo();
    updateGroupUIForModule();

    const moduleData = modulesData[currentModuleId];
    const isLlu = isLluModule(currentModuleId);
    const baseTasks = isLlu ? TASKS_LLU : TASKS_STANDARD;
    const indices = getVisibleTaskIndices(currentModuleId);

    indices.forEach((taskIndex) => {
      const item = document.createElement("div");
      item.className = "task-item";

      const num = document.createElement("div");
      num.className = "task-num";
      num.textContent = taskIndex + 1;

      const labelDiv = document.createElement("div");
      labelDiv.className = "task-text";
      labelDiv.textContent = baseTasks[taskIndex];

      // ---------- –ß–ï–ö–ë–û–ö–° –û–¢–ö ----------
      const qaWrapper = document.createElement("label");
      qaWrapper.className = "task-checkbox";

      const qaCheckbox = document.createElement("input");
      qaCheckbox.type = "checkbox";
      qaCheckbox.checked = moduleData.qaTasks[taskIndex];

      qaCheckbox.disabled = (currentRole === "viewer");

      qaCheckbox.addEventListener("change", () => {
        if (currentRole === "viewer") {
          qaCheckbox.checked = moduleData.qaTasks[taskIndex];
          return;
        }

        const prev = moduleData.qaTasks[taskIndex];
        const next = qaCheckbox.checked;

        if (!prev && next) {
          if (currentRole === "otk" || currentRole === "chief") {
            moduleData.qaTasks[taskIndex] = true;
          } else {
            qaCheckbox.checked = prev;
          }
        } else if (prev && !next) {
          if (currentRole === "chief") {
            moduleData.qaTasks[taskIndex] = false;
          } else {
            alert("–°–Ω—è—Ç—å –≥–∞–ª–æ—á–∫—É –º–æ–∂–µ—Ç —Ç–æ–ª—å–∫–æ —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å –û–¢–ö.");
            qaCheckbox.checked = true;
          }
        }

        updateModuleStats();
        updateSummaryTable();
        saveToFirestore();
      });

      qaWrapper.appendChild(qaCheckbox);
      qaWrapper.appendChild(document.createTextNode("–û–¢–ö"));

      // ---------- –ü–û–õ–ï –ö–û–ú–ú–ï–ù–¢–ê–†–ò–Ø ----------
      const commentInput = document.createElement("input");
      commentInput.type = "text";
      commentInput.className = "task-comment-input";
      commentInput.placeholder = "–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π";
      commentInput.value = moduleData.comments[taskIndex] || "";
      commentInput.disabled = (currentRole === "viewer");

      commentInput.addEventListener("change", () => {
        if (currentRole === "viewer") {
          commentInput.value = moduleData.comments[taskIndex] || "";
          return;
        }
        moduleData.comments[taskIndex] = commentInput.value;
        saveToFirestore();
      });

      const rightCol = document.createElement("div");
      rightCol.className = "task-right";
      rightCol.appendChild(qaWrapper);
      rightCol.appendChild(commentInput);

      item.appendChild(num);
      item.appendChild(labelDiv);
      item.appendChild(rightCol);
      container.appendChild(item);
    });

    updateModuleStats();
  }

  function initTabs() {
    const buttons = document.querySelectorAll(".tab-button");
    const contents = document.querySelectorAll(".tab-content");

    buttons.forEach((btn) => {
      btn.addEventListener("click", () => {
        const tab = btn.getAttribute("data-tab");

        buttons.forEach((b) => b.classList.remove("active"));
        contents.forEach((c) => c.classList.remove("tab-active"));

        btn.classList.add("active");
        document.getElementById("tab-" + tab).classList.add("tab-active");
      });
    });
  }

  function getColorForPercent(p) {
    const r1 = 220, g1 = 38,  b1 = 38;
    const r2 = 255, g2 = 165, b2 = 0;
    const r3 = 22,  g3 = 163, b3 = 74;

    let r, g, b;

    if (p < 50) {
      const t = p / 50;
      r = r1 + (r2 - r1) * t;
      g = g1 + (g2 - g1) * t;
      b = b1 + (b2 - b1) * t;
    } else {
      const t = (p - 50) / 50;
      r = r2 + (r3 - r2) * t;
      g = g2 + (g3 - g2) * t;
      b = b2 + (b3 - b2) * t;
    }

    return `rgb(${Math.round(r)}, ${Math.round(g)}, ${Math.round(b)})`;
  }

  document.addEventListener("DOMContentLoaded", async () => {
    initTabs();
    await loadFromFirestore();
    populateModuleSelect();
    populateGroupSelect();
    populateFloorFilter();
    renderTasks();
    updateSummaryTable();
    updateRoleUI();

    document.getElementById("moduleSelect").addEventListener("change", (e) => {
      currentModuleId = e.target.value;
      renderTasks();
    });

    document.getElementById("groupSelect").addEventListener("change", (e) => {
      currentGroup = e.target.value;
      renderTasks();
    });

    document.getElementById("floorFilterSelect").addEventListener("change", (e) => {
      currentFloorFilter = e.target.value;
      updateSummaryTable();
    });

    document.getElementById("resetModule").addEventListener("click", () => {
      if (currentRole !== "chief") {
        alert("–°–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ –æ—Ç–º–µ—Ç–∫–∏ –º–æ–∂–µ—Ç —Ç–æ–ª—å–∫–æ —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å –û–¢–ö.");
        return;
      }
      if (confirm("–°–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ –æ—Ç–º–µ—Ç–∫–∏ –ø–æ " + currentModuleId + "?")) {
        resetCurrentModule();
      }
    });

    document
      .getElementById("roleSelect")
      .addEventListener("change", handleRoleChange);
    document
      .getElementById("exportCsv")
      .addEventListener("click", exportSummaryToCsv);
    document
      .getElementById("exportModuleCsv")
      .addEventListener("click", exportModuleChecklistToCsv);
  });
</script>
</body>
</html>
