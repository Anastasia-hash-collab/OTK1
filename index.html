<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<title>–ö–æ–Ω—Ç—Ä–æ–ª—å –∫–∞—á–µ—Å—Ç–≤–∞ –ò–û–† –≤ –º–æ–¥—É–ª–µ. (–í—ã–∫–ª—é—á–∏—Ç–µ VPN)</title>

<style>
  * { box-sizing: border-box; }
  body {
    margin: 0;
    font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    background: #F8FAFC;
    color: #0f172a;
  }

  /* ---------------- HEADER ---------------- */

  header {
    background: #1E3A8A;
    color: white;
    padding: 14px 22px;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  header h1 {
    margin: 0;
    font-size: 20px;
    font-weight: 600;
  }

  header small {
    opacity: 0.9;
    font-size: 13px;
  }

  .role-bar {
    display: flex;
    gap: 10px;
    align-items: center;
    font-size: 13px;
  }

  .role-select {
    padding: 6px 10px;
    border-radius: 8px;
    border: none;
    background: white;
    color: #1E3A8A;
    font-weight: 600;
  }

  .role-badge {
    background: rgba(255,255,255,0.16);
    padding: 4px 10px;
    border-radius: 6px;
    font-size: 12px;
  }

  /* ---------------- LAYOUT & TABS ---------------- */

  main {
    padding: 14px;
    max-width: 1200px;
    margin: 0 auto;
  }

  .tabs {
    display: flex;
    gap: 8px;
    margin-bottom: 12px;
    border-bottom: 1px solid #E2E8F0;
  }

  .tab-button {
    padding: 8px 14px;
    border: none;
    background: transparent;
    cursor: pointer;
    font-size: 13px;
    font-weight: 600;
    color: #64748B;
    border-radius: 8px 8px 0 0;
  }

  .tab-button.active {
    background: white;
    color: #1E3A8A;
    box-shadow: 0 -1px 0 white;
  }

  .tab-content {
    display: none;
  }

  .tab-content.tab-active {
    display: block;
  }

  .card {
    background: white;
    border-radius: 16px;
    padding: 16px;
    box-shadow: 0 4px 18px rgba(15, 23, 42, 0.08);
    border: 1px solid #E2E8F0;
  }

  .card-header-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 8px;
    margin-bottom: 8px;
  }

  .card-title {
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .card-title-icon {
    width: 22px;
    height: 22px;
    border-radius: 999px;
    background: #DBEAFE;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #1D4ED8;
    font-size: 13px;
  }

  .card h2 {
    font-size: 17px;
    margin: 0;
    color: #1e3a8a;
  }

  .controls {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
  }

  label {
    font-size: 12px;
    font-weight: 500;
    color: #475569;
    display: block;
    margin-bottom: 2px;
  }

  select {
    padding: 6px 10px;
    border-radius: 8px;
    border: 1px solid #CBD5E1;
    background: white;
    color: #1E3A8A;
    font-weight: 600;
    min-width: 80px;
  }

  .info-row {
    margin: 4px 0 8px;
    font-size: 12px;
    color: #475569;
    display: flex;
    justify-content: space-between;
    gap: 10px;
  }

  /* ---------------- PROGRESS RINGS ---------------- */

  .progress-wrap {
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .progress-ring {
    width: 46px;
    height: 46px;
  }

  .progress-ring circle {
    fill: transparent;
    stroke-width: 5;
    transform: rotate(-90deg);
    transform-origin: 50% 50%;
  }

  .progress-bg {
    stroke: #E5E7EB;
  }

  .progress-value {
    stroke: #3B82F6;
    stroke-linecap: round;
    stroke-dasharray: 0 999;
    stroke-dashoffset: 0;
  }

  .progress-label {
    font-size: 11px;
    color: #64748B;
  }

  /* ---------------- TASKS ---------------- */

  .tasks {
    max-height: 60vh;
    overflow-y: auto;
    margin-top: 10px;
    border-top: 1px solid #E2E8F0;
  }

  .task-item {
    padding: 8px 4px;
    border-bottom: 1px solid #E2E8F0;
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .task-num {
    width: 26px;
    text-align: right;
    font-size: 12px;
    color: #64748B;
  }

  .task-text {
    flex: 1;
    font-size: 13px;
    color: #0f172a;
  }

  .task-checkbox {
    display: flex;
    gap: 4px;
    align-items: center;
    color: #475569;
    font-size: 12px;
    white-space: nowrap;
  }

  .task-checkbox input {
    width: 16px;
    height: 16px;
  }

  .task-right {
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    gap: 4px;
    min-width: 140px;
  }

  .task-comment-input {
    width: 160px;
    max-width: 50vw;
    padding: 3px 6px;
    font-size: 11px;
    border-radius: 6px;
    border: 1px solid #CBD5E1;
  }
 .task-user-select {
  width: 160px;
  max-width: 50vw;
  padding: 3px 6px;
  font-size: 11px;
  border-radius: 6px;
  border: 1px solid #CBD5E1;
  background: #FFFFFF;
}

@media (max-width: 480px) {
  .task-user-select {
    width: 100%;
    max-width: 100%;
  }
}

  /* ---------------- STATUS / BUTTONS ---------------- */

  .footer-status {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 10px;
    padding-top: 10px;
    border-top: 1px solid #E2E8F0;
    font-size: 13px;
    gap: 10px;
    flex-wrap: wrap;
  }

  .badge {
    padding: 6px 12px;
    border-radius: 10px;
    font-weight: 600;
    font-size: 12px;
  }

  .badge-ready {
    background: #DCFCE7;
    color: #166534;
  }

  .badge-not-ready {
    background: #FEE2E2;
    color: #B91C1C;
  }

  .badge-inprogress {
    background: #DBEAFE;
    color: #1D4ED8;
  }

  button {
    padding: 6px 12px;
    background: #3B82F6;
    color: white;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
    font-size: 12px;
  }

  button:hover {
    background: #2563EB;
  }

  button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  /* ---------------- TABLE ---------------- */

  .summary-header-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin: 12px 0 6px;
    gap: 8px;
  }

  .summary-header-left {
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .tag {
    padding: 4px 10px;
    border-radius: 999px;
    background: #DBEAFE;
    color: #1E3A8A;
    font-size: 12px;
    font-weight: 600;
  }

  .summary-table-wrapper {
    width: 100%;
    overflow-x: auto;
  }

  .summary-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 4px;
    min-width: 360px;
  }

  .summary-table th {
    background: #EFF6FF;
    font-size: 11px;
    padding: 6px 8px;
    text-transform: uppercase;
    border-bottom: 2px solid #BFDBFE;
    color: #1e3a8a;
  }

  .summary-table td {
    padding: 6px 8px;
    border-bottom: 1px solid #E2E8F0;
    font-size: 12px;
  }

  .row-ready {
    background: #ECFDF5;
  }

  .percent-cell {
    font-variant-numeric: tabular-nums;
  }

  #floorFilterSelect {
    padding: 4px 8px;
    border-radius: 8px;
    border: 1px solid #CBD5E1;
    background: white;
    color: #1E3A8A;
    font-size: 11px;
    font-weight: 500;
  }

  .percent-colored {
    font-weight: 600;
    color: white;
    padding: 4px 8px;
    border-radius: 6px;
    text-align: center;
    min-width: 55px;
    display: inline-block;
  }

  @media (max-width: 600px) {
    header {
      flex-direction: column;
      align-items: flex-start;
      gap: 8px;
    }
    .role-bar {
      align-self: flex-end;
    }
  }

  @media (max-width: 480px) {
    body {
      font-size: 14px;
    }

    header {
      padding: 10px 12px;
      flex-direction: column;
      align-items: flex-start;
      gap: 6px;
    }

    header h1 {
      font-size: 16px;
    }

    main {
      padding: 10px;
    }

    .card {
      padding: 12px;
      border-radius: 12px;
    }

    .controls {
      flex-direction: column;
      align-items: flex-start;
      gap: 8px;
    }

    .info-row {
      flex-direction: column;
      align-items: flex-start;
      gap: 2px;
    }

    .tasks {
      max-height: 55vh;
    }

    .task-item {
      align-items: flex-start;
    }

    .task-checkbox {
      font-size: 13px;
    }

    .task-checkbox input {
      width: 20px;
      height: 20px;
    }

    .tabs {
      overflow-x: auto;
    }

    .tab-button {
      white-space: nowrap;
      padding: 8px 10px;
    }

    .summary-header-row {
      flex-direction: column;
      align-items: flex-start;
      gap: 4px;
    }

    .task-right {
      align-items: stretch;
    }
    .task-comment-input {
      width: 100%;
      max-width: 100%;
    }
  }
</style>
</head>

<body>

<header>
  <div>
    <h1>–ö–æ–Ω—Ç—Ä–æ–ª—å –∫–∞—á–µ—Å—Ç–≤–∞ –ò–û–† –≤ –º–æ–¥—É–ª–µ. (–í—ã–∫–ª—é—á–∏—Ç–µ VPN)</h1>
    <small>–ß–µ—Ä—ë–º—É—à–∫–∏ ¬∑ –ö–æ—Ä–ø—É—Å 1 ¬∑ —Å–µ–∫—Ü–∏—è 2 ¬∑ –û–¢–ö</small>
  </div>
  <div class="role-bar">
    <span>–†–µ–∂–∏–º:</span>
    <select id="roleSelect" class="role-select">
      <option value="viewer">–ü—Ä–æ—Å–º–æ—Ç—Ä</option>
      <option value="otk">–û–¢–ö</option>
      <option value="chief">–†—É–∫. –û–¢–ö</option>
    </select>
    <span id="roleBadge" class="role-badge">–¢–æ–ª—å–∫–æ –ø—Ä–æ—Å–º–æ—Ç—Ä</span>
  </div>
</header>

<main>
  <div class="tabs">
    <button class="tab-button active" data-tab="module">–ß–µ–∫-–ª–∏—Å—Ç</button>
    <button class="tab-button" data-tab="section">–°–≤–æ–¥–Ω–∞—è –ø–æ —Å–µ–∫—Ü–∏–∏</button>
  </div>

  <!-- TAB: MODULE -->
  <div class="tab-content tab-active" id="tab-module">
    <section class="card">
      <div class="card-header-row">
        <div class="card-title">
          <div class="card-title-icon">üèó</div>
          <h2>–†–∞–±–æ—Ç—ã –ø–æ –º–æ–¥—É–ª—é</h2>
        </div>
        <div class="controls">
          <div>
            <label>–ú–æ–¥—É–ª—å</label>
            <select id="moduleSelect"></select>
          </div>
          <div>
            <label>–ì—Ä—É–ø–ø–∞</label>
            <select id="groupSelect"></select>
          </div>
        </div>
      </div>

      <div class="info-row">
        <span id="moduleTypeHint">–¢–∏–ø–æ–≤–æ–π –º–æ–¥—É–ª—å</span>
        <span id="moduleFloorInfo">–≠—Ç–∞–∂: 2</span>
      </div>

      <div id="tasksContainer" class="tasks"></div>

      <div class="footer-status">
        <div class="progress-wrap">
          <svg class="progress-ring" viewBox="0 0 40 40">
            <circle class="progress-bg" cx="20" cy="20" r="16"></circle>
            <circle id="moduleProgressCircle" class="progress-value" cx="20" cy="20" r="16"></circle>
          </svg>
          <div>
            <div id="percentQA">–ü—Ä–∏–Ω—è—Ç–æ –û–¢–ö: 0%</div>
            <div class="progress-label">–¢–µ–∫—É—â–∏–π –º–æ–¥—É–ª—å</div>
          </div>
        </div>
        <span id="statusBadge" class="badge badge-not-ready">–ù–µ –Ω–∞—á–∞—Ç–æ</span>
        <div style="display:flex; gap:6px; flex-wrap:wrap;">
          <button id="exportModuleCsv">–≠–∫—Å–ø–æ—Ä—Ç —á–µ–∫-–ª–∏—Å—Ç–∞</button>
          <button id="resetModule">–°–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ</button>
        </div>
      </div>
    </section>
  </div>

  <!-- TAB: SECTION -->
  <div class="tab-content" id="tab-section">
    <section class="card">
      <div class="card-header-row">
        <div class="card-title">
          <div class="card-title-icon">üìä</div>
          <h2>–°–≤–æ–¥–Ω–∞—è –ø–æ —Å–µ–∫—Ü–∏–∏</h2>
        </div>
        <div class="progress-wrap">
          <svg class="progress-ring" viewBox="0 0 40 40">
            <circle class="progress-bg" cx="20" cy="20" r="16"></circle>
            <circle id="sectionProgressCircle" class="progress-value" cx="20" cy="20" r="16"></circle>
          </svg>
          <div>
            <div id="sectionPercentQA">–ü—Ä–∏–Ω—è—Ç–æ –û–¢–ö: 0%</div>
            <div class="progress-label">–í—Å—è —Å–µ–∫—Ü–∏—è</div>
          </div>
        </div>
      </div>

      <div class="footer-status">
        <span id="sectionStatusBadge" class="badge badge-not-ready">–°–µ–∫—Ü–∏—è –Ω–µ –Ω–∞—á–∞—Ç–∞</span>
        <button id="exportCsv">–≠–∫—Å–ø–æ—Ä—Ç CSV</button>
      </div>

      <div class="summary-header-row">
        <div class="summary-header-left">
          <strong>–ú–æ–¥—É–ª–∏</strong>
          <select id="floorFilterSelect"></select>
        </div>
        <span id="summaryReadyCount" class="tag">–ì–æ—Ç–æ–≤–æ: 0</span>
      </div>

      <div class="summary-table-wrapper">
        <table class="summary-table">
          <thead>
          <tr>
            <th>–ú–æ–¥—É–ª—å</th>
            <th>–≠—Ç–∞–∂</th>
            <th>%</th>
            <th>–°—Ç–∞—Ç—É—Å</th>
          </tr>
          </thead>
          <tbody id="summaryTableBody"></tbody>
        </table>
      </div>
    </section>
  </div>
</main>

<!-- ---------------- FIREBASE ---------------- -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyBwWguFZ48BuuYpIG8nEX1zHAIx3BOXFsI",
    authDomain: "qc-modules.firebaseapp.com",
    projectId: "qc-modules",
    storageBucket: "qc-modules.firebasestorage.app",
    messagingSenderId: "430400564818",
    appId: "1:430400564818:web:2e46915026cedd4323798b",
    measurementId: "G-LHCERM1GLW"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  const docRef = db.collection("qc_modules").doc("section1");
</script>

<!-- ---------------- APP LOGIC ---------------- -->
<script>
const TOTAL_MODULES = 132;
const MODULES_PER_FLOOR = 6;

// –ü–∞—Ä–æ–ª–∏ —Ä–æ–ª–µ–π
const ROLE_PASSWORDS = {
  otk: "otk123",
  chief: "1212"
};

// –¢–µ–∫—Å—Ç—ã –±–µ–π–¥–∂–µ–π —Ä–æ–ª–µ–π
const ROLE_LABELS = {
  viewer: "–¢–æ–ª—å–∫–æ –ø—Ä–æ—Å–º–æ—Ç—Ä",
  otk: "–û–¢–ö: –º–æ–∂–Ω–æ —Å—Ç–∞–≤–∏—Ç—å –≥–∞–ª–æ—á–∫–∏",
  chief: "–†—É–∫. –û–¢–ö: –º–æ–∂–Ω–æ —Å—Ç–∞–≤–∏—Ç—å –∏ —Å–Ω–∏–º–∞—Ç—å"
};

// –§–∞–º–∏–ª–∏–∏ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –û–¢–ö
const OTK_USERS = [
  "–ë–æ–ª—å—à–∞—è",
  "–°–æ–ª–æ–≤—å–µ–≤–∞",
  "–ú–∏—Ö–∞–ª–µ–≤–∞",
  "–¢–∞–π–º–∞–∑–æ–≤",
  "–ö–æ–∑–ª–µ—á–∫–æ–≤–∞",
  "–ë–∞—Ä—Å–µ–≥—è–Ω",
  "–°—Ç—Ä—É—á–∫–æ–≤–∞"
];

// –°–ø–∏—Å–∫–∏ –∑–∞–¥–∞—á
const TASKS_STANDARD = [
  "–°–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–µ—Ä–µ–≥–æ—Ä–æ–¥–∫–∏ –ì–ö–õ + –∑–≤—É–∫–æ–∏–∑–æ–ª—è—Ü–∏—è.",
  "–°–∞–Ω—Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π –º–æ–¥—É–ª—å, —à–æ–≤ –∑–∞–ª–∏—Ç –ø–æ –∫–æ–Ω—Ç—É—Ä—É.",
  "–û—Ç–¥–µ–ª–∫–∞ —Å–∞–Ω—É–∑–ª–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞, —Ñ–∞—è–Ω—Å –∏ —Å–º–µ—Å–∏—Ç–µ–ª–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã.",
  "–ü–æ—Ç–æ–ª–æ–∫: –º–µ—Ç–∞–ª–ª–æ–∫–∞—Ä–∫–∞—Å + —Ü–µ–º–µ–Ω—Ç–Ω–æ-–ø–µ—Ä–ª–∏—Ç–æ–≤—ã–µ –ø–ª–∏—Ç—ã –Ω–∞ –∞–Ω–∫–µ—Ä–∞—Ö.",
  "–ö–æ—Ä–æ–±–∫–∏, –ø–æ–¥—Ä–æ–∑–µ—Ç–Ω–∏–∫–∏, –∫–∞–±–µ–ª—å, —Ä–∞—Å–∫–ª—é—á–µ–Ω–∏–µ.",
  "–ö–≤–∞—Ä—Ç–∏—Ä–Ω—ã–µ —ç–ª–µ–∫—Ç—Ä–∏—á–µ—Å–∫–∏–µ —â–∏—Ç–∫–∏ —Å–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω—ã.",
  "–ì–∏–ª—å–∑—ã –≠–û–ú (–ú–û–ü) —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã.",
  "–ö–≤–∞—Ä—Ç–∏—Ä–Ω–∞—è —Ä–∞–∑–≤–æ–¥–∫–∞ –≤–µ–Ω—Ç–∏–ª—è—Ü–∏–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞.",
  "–î—ã–º–æ—É–¥–∞–ª–µ–Ω–∏–µ –∏ –¥—ã–º–æ–ø—Ä–∏—ë–º–Ω–∏–∫–∏ —Å–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω—ã.",
  "–°–∏—Å—Ç–µ–º–∞ –ø–æ–∂–∞—Ä–æ—Ç—É—à–µ–Ω–∏—è + –≥–ª–∞–≤–Ω—ã–π —Å—Ç–æ—è–∫.",
  "–í–æ–¥–æ—Å–Ω–∞–±–∂–µ–Ω–∏–µ –∏ –∫–∞–Ω–∞–ª–∏–∑–∞—Ü–∏—è (+ –ö1 —Å—Ç–æ—è–∫).",
  "–°—Ç–æ—è–∫ –ö2.",
  "–û—Ç–æ–ø–ª–µ–Ω–∏–µ, —Å—Ç–æ—è–∫–∏.",
  "–†–∞–¥–∏–∞—Ç–æ—Ä—ã —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã.",
  "–ó–∞—á–µ–∫–∞–Ω–∫–∞ —Ç–µ—Ö. –æ—Ç–≤–µ—Ä—Å—Ç–∏–π (–≤–µ–Ω—Ç, –ö1).",
  "–ö–∞—Ä–∫–∞—Å –∑–∞—à–∏–≤–∫–∏ –∏–Ω–∂–µ–Ω–µ—Ä–Ω—ã—Ö —Å–∏—Å—Ç–µ–º –ú–û–ü.",
  "–ü—Ä–æ—Ç–∏–≤–æ–ø–æ–∂–∞—Ä–Ω—ã–µ –æ—Ç—Å–µ—á–∫–∏ –ú–û–ü.",
  "–û–∫–Ω–∞/–¥–≤–µ—Ä–∏ (–∞–ª—é–º–∏–Ω–∏–π, –ü–í–•), —à–≤—ã –≥–µ—Ä–º–µ—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω—ã.",
  "–ü–æ–¥–æ–∫–æ–Ω–Ω–∏–∫–∏ –∏ –æ—Ç–∫–æ—Å—ã –æ–∫—Ä–∞—à–µ–Ω—ã.",
  "–ü–ª–∏—Ç–∫–∞: —Ñ–∞—Ä—Ç—É–∫, –∫—É—Ö–Ω—è, –∫–æ—Ä–∏–¥–æ—Ä, –±–∞–ª–∫–æ–Ω + –∑–∞—Ç–∏—Ä–∫–∞.",
  "–ú–æ–∫—Ä—ã–π —à—Ç—É–∫–∞—Ç—É—Ä–Ω—ã–π —Ñ–∞—Å–∞–¥ –±–∞–ª–∫–æ–Ω–∞.",
  "–ö—Ä–æ–Ω—à—Ç–µ–π–Ω—ã –ø–æ–¥—Å–∏—Å—Ç–µ–º—ã –ù–í–§.",
  "–£—Ç–µ–ø–ª–∏—Ç–µ–ª—å –ø–æ —Ñ–∞—Å–∞–¥—É.",
  "–ü—Ä–æ—Ç–∏–≤–æ–ø–æ–∂–∞—Ä–Ω–∞—è –æ—Ç—Å–µ—á–∫–∞ –°–ü–ö."
];

const TASKS_ADJ_LLU = [
  "–ü–æ—Ç–æ–ª–æ–∫: –ø–ª–∏—Ç—ã –Ω–∞ –∞–Ω–∫–µ—Ä–∞—Ö (–õ–õ–£).",
  "–ö–æ—Ä–æ–±–∫–∏, –∫–∞–±–µ–ª—å, —Ä–∞—Å–∫–ª—é—á–µ–Ω–∏–µ (–õ–õ–£).",
  "–ì–∏–ª—å–∑—ã –≠–û–ú (–ú–û–ü) (–õ–õ–£).",
  "–°—Ç–æ—è–∫–∏ –æ—Ç–æ–ø–ª–µ–Ω–∏—è (–õ–õ–£).",
  "–†–∞–¥–∏–∞—Ç–æ—Ä—ã (–õ–õ–£).",
  "–ö–∞—Ä–∫–∞—Å –∑–∞—à–∏–≤–∫–∏ –∏–Ω–∂–µ–Ω–µ—Ä–Ω—ã—Ö —Å–∏—Å—Ç–µ–º –ú–û–ü (–õ–õ–£).",
  "–ü—Ä–æ—Ç–∏–≤–æ–ø–æ–∂–∞—Ä–Ω—ã–µ –æ—Ç—Å–µ—á–∫–∏ –ú–û–ü (–õ–õ–£).",
  "–û–∫–Ω–∞/–¥–≤–µ—Ä–∏, –≥–µ—Ä–º–µ—Ç–∏–∑–∞—Ü–∏—è (–õ–õ–£).",
  "–ü–æ–¥–æ–∫–æ–Ω–Ω–∏–∫–∏ –∏ –æ—Ç–∫–æ—Å—ã (–õ–õ–£).",
  "–ü–ª–∏—Ç–∫–∞ –±–∞–ª–∫–æ–Ω–∞ + –∑–∞—Ç–∏—Ä–∫–∞ (–õ–õ–£).",
  "–ú–æ–∫—Ä—ã–π —Ñ–∞—Å–∞–¥ –±–∞–ª–∫–æ–Ω–∞ (–õ–õ–£).",
  "–ö—Ä–æ–Ω—à—Ç–µ–π–Ω—ã –ø–æ–¥—Å–∏—Å—Ç–µ–º—ã –ù–í–§ (–õ–õ–£).",
  "–£—Ç–µ–ø–ª–∏—Ç–µ–ª—å –ø–æ —Ñ–∞—Å–∞–¥—É (–õ–õ–£).",
  "–ü—Ä–æ—Ç–∏–≤–æ–ø–æ–∂–∞—Ä–Ω–∞—è –æ—Ç—Å–µ—á–∫–∞ –°–ü–ö (–õ–õ–£)."
];

const TASKS_FLOOR4_LLU = [
  "–ö–∞—Ä–∫–∞—Å –∑–∞—à–∏–≤–∫–∏ –∏–Ω–∂–µ–Ω–µ—Ä–Ω—ã—Ö —Å–∏—Å—Ç–µ–º –ú–û–ü (4).",
  "–°—Ç–æ—è–∫–∏ –æ—Ç–æ–ø–ª–µ–Ω–∏—è (4).",
  "–†–∞–¥–∏–∞—Ç–æ—Ä—ã (4).",
  "–°–∏—Å—Ç–µ–º—ã –î–í, –î–ü (4).",
  "–î–≤–µ—Ä–∏ –õ–õ–£ (4).",
  "–û–∫–Ω–∞, —Å—Ç–µ–∫–ª–æ–ø–∞–∫–µ—Ç—ã, –∑–∞—á–µ–∫–∞–Ω–∫–∞ —à–≤–æ–≤ (4).",
  "–ü–ª–∏—Ç–∫–∞ –õ–õ–£ (4).",
  "–ö—Ä–æ–Ω—à—Ç–µ–π–Ω—ã –ø–æ–¥—Å–∏—Å—Ç–µ–º—ã –ù–í–§ (4).",
  "–£—Ç–µ–ø–ª–∏—Ç–µ–ª—å –ø–æ —Ñ–∞—Å–∞–¥—É (4).",
  "–ü—Ä–æ—Ç–∏–≤–æ–ø–æ–∂–∞—Ä–Ω–∞—è –æ—Ç—Å–µ—á–∫–∞ –°–ü–ö (4)."
];

// –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —ç—Ç–∞–∂–∞
function getFloor(moduleId) {
  const num = parseInt(moduleId.replace("M",""), 10);
  return 1 + Math.floor((num - 1) / MODULES_PER_FLOOR);
}

// –¢–∏–ø –º–æ–¥—É–ª—è –ø–æ –ø–æ–∑–∏—Ü–∏–∏ –Ω–∞ —ç—Ç–∞–∂–µ
function getModuleType(moduleId) {
  const num = parseInt(moduleId.replace("M",""),10);
  const pos = ((num - 1) % MODULES_PER_FLOOR) + 1;
  if (pos === 3) return "adj_llu";
  if (pos === 4) return "floor4_llu";
  return "standard";
}

// –ü–æ–ª—É—á–∏—Ç—å –∑–∞–¥–∞—á–∏ –ø–æ —Ç–∏–ø—É
function getTasksForModule(moduleId) {
  const type = getModuleType(moduleId);
  if (type === "adj_llu") return TASKS_ADJ_LLU;
  if (type === "floor4_llu") return TASKS_FLOOR4_LLU;
  return TASKS_STANDARD;
}

// –†–∞—Å—á—ë—Ç % –ø—Ä–∏–Ω—è—Ç–∏—è –û–¢–ö
function percentDone(arr) {
  const done = arr.filter(Boolean).length;
  return Math.round(done / arr.length * 100);
}

// –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –∑–∞–¥–∞—á
function renderTasks() {
  const container = document.getElementById("tasksContainer");
  container.innerHTML = "";

  const data = modulesData[currentModuleId] || { qaTasks: [], comments: [], qaUsers: [] };
  const tasks = getTasksForModule(currentModuleId);
  ensureModuleArraysSize(currentModuleId);

  tasks.forEach((taskText, i) => {
    const row = document.createElement("div");
    row.className = "task-item";

    const left = document.createElement("div");
    left.className = "task-text";
    left.textContent = taskText;

    const check = document.createElement("input");
    check.type = "checkbox";
    check.checked = data.qaTasks[i];
    check.disabled = currentRole === "viewer" || (currentRole === "otk" && !authenticatedRoles.otk);

    const selectUser = document.createElement("select");
    selectUser.className = "task-user-select";
    const opt0 = document.createElement("option");
    opt0.value = "";
    opt0.textContent = "- —Ñ–∞–º–∏–ª–∏—è –û–¢–ö -";
    selectUser.appendChild(opt0);
    OTK_USERS.forEach(u => {
      const o = document.createElement("option");
      o.value = u;
      o.textContent = u;
      selectUser.appendChild(o);
    });
    selectUser.value = data.qaUsers[i] || "";
    selectUser.disabled = currentRole === "viewer" || !data.qaTasks[i];

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏/—Å–Ω—è—Ç–∏—è –≥–∞–ª–æ—á–µ–∫
    check.addEventListener("change", () => {
      const prev = data.qaTasks[i];
      const next = check.checked;

      if (!prev && next) {
        if (currentRole === "otk" || currentRole === "chief") {
          data.qaTasks[i] = true;
          data.qaUsers[i] = OTK_USERS[0] || "";
          selectUser.value = data.qaUsers[i];
        } else {
          check.checked = false;
        }
      }

      if (prev && !next) {
        if (currentRole === "chief") {
          data.qaTasks[i] = false;
          data.qaUsers[i] = "";
          selectUser.value = "";
        } else {
          alert("–°–Ω—è—Ç—å –≥–∞–ª–æ—á–∫—É –º–æ–∂–µ—Ç —Ç–æ–ª—å–∫–æ —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å –û–¢–ö.");
          check.checked = true;
        }
      }

      updateModuleStats();
      updateSummaryTable();
      saveToFirestore();
    });

    // –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏
    const inputComment = document.createElement("input");
    inputComment.type = "text";
    inputComment.className = "task-comment-input";
    inputComment.placeholder = "–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π";
    inputComment.value = data.comments[i] || "";
    inputComment.disabled = currentRole === "viewer";

    inputComment.addEventListener("change", () => {
      if (currentRole !== "viewer") {
        data.comments[i] = inputComment.value;
        saveToFirestore();
      }
    });

    // –í—ã–±–æ—Ä —Ñ–∞–º–∏–ª–∏–∏
    selectUser.addEventListener("change", () => {
      if (currentRole !== "viewer" && data.qaTasks[i]) {
        data.qaUsers[i] = selectUser.value;
        selectUser.disabled = true; // –∑–∞–ø—Ä–µ—Ç —Å–Ω—è—Ç–∏—è –ø–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞
        saveToFirestore();
      } else {
        selectUser.value = "";
      }
    });

    const right = document.createElement("div");
    right.className = "task-right";
    right.appendChild(check);
    right.appendChild(selectUser);
    right.appendChild(inputComment);

    row.appendChild(left);
    row.appendChild(right);
    container.appendChild(row);
  });
}

// –°–≤–æ–¥–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞
function updateSummaryTable() {
  const tbody = document.getElementById("summaryTableBody");
  tbody.innerHTML = "";

  let readyCount = 0;
  let sumQA = 0;

  for (let i = 1; i <= TOTAL_MODULES; i++) {
    const id = "M" + i;
    const m = modulesData[id];
    const p = percentDone(m.qaTasks);
    sumQA += p;
    if (p === 100) readyCount++;
    const floor = getFloor(id);

    const tr = document.createElement("tr");
    if (p === 100) tr.classList.add("row-ready");

    tr.innerHTML = `
      <td>${id}</td>
      <td>${floor}</td>
      <td class="percent-cell"><span class="percent-colored">${p}%</span></td>
      <td>${statusByPercent(p)}</td>
    `;

    tbody.appendChild(tr);
  }

  const sectionPercent = Math.round(sumQA / TOTAL_MODULES);
  document.getElementById("sectionPercentQA").textContent = "–ü—Ä–∏–Ω—è—Ç–æ –û–¢–ö: " + sectionPercent + "%";
  document.getElementById("summaryReadyCount").textContent = "–ì–æ—Ç–æ–≤–æ: " + readyCount;
  updateProgressCircle("sectionProgressCircle", sectionPercent);
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞
function statusByPercent(p) {
  if (p === 0) return "–ù–µ –Ω–∞—á–∞—Ç–æ";
  if (p === 100) return "–ì–æ—Ç–æ–≤–æ";
  return "–í —Ä–∞–±–æ—Ç–µ";
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
function updateModuleStats() {
  const m = modulesData[currentModuleId];
  const p = percentDone(m.qaTasks);
  document.getElementById("percentQA").textContent = "–ü—Ä–∏–Ω—è—Ç–æ –û–¢–ö: " + p + "%";

  const badge = document.getElementById("statusBadge");
  badge.textContent = statusByPercent(p);
  badge.className = badgeClassByPercent("badge", p);
  updateProgressCircle("moduleProgressCircle", p);
}

// –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ä–æ–ª–∏
document.getElementById("roleSelect").addEventListener("change", (e) => {
  const role = e.target.value;
  if (role !== "viewer" && !authenticatedRoles[role]) {
    const pwd = prompt("–ü–∞—Ä–æ–ª—å:");
    if (pwd === ROLE_PASSWORDS[role]) authenticatedRoles[role] = true;
    else {
      alert("–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å");
      e.target.value = currentRole;
      return;
    }
  }
  currentRole = role;
  updateRoleUI();
});

// UI –±–µ–π–¥–∂–∞ —Ä–æ–ª–∏
function updateRoleUI() {
  document.getElementById("roleBadge").textContent = ROLE_LABELS[currentRole];
  renderTasks();
}

// –°–±—Ä–æ—Å –º–æ–¥—É–ª—è
document.getElementById("resetModule").addEventListener("click", () => {
  if (currentRole !== "chief") return alert("–°–±—Ä–æ—Å –¥–æ—Å—Ç—É–ø–µ–Ω —Ç–æ–ª—å–∫–æ —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—é –û–¢–ö.");
  const t = getTasksForModule(currentModuleId).length;
  modulesData[currentModuleId] = { qaTasks: Array(t).fill(false), comments: Array(t).fill(""), qaUsers: Array(t).fill("") };
  renderTasks();
  updateSummaryTable();
  saveToFirestore();
});

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
document.addEventListener("DOMContentLoaded", async () => {
  await loadFromFirestore();
  renderTasks();
  updateSummaryTable();
});
</script>
</body>
</html>

